# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/authoring-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: cnab-aks-winlin
version: 0.1.0
description: "A Porter bundle that creates a multiple OS Kubernetes cluster on AKS, with taints applied."
invocationImage: squillace/cnab-aks-winlin-install:latest
tag: squillace/cnab-aks-winlin:latest

# Uncomment out the line below to use a template Dockerfile for your invocation image
dockerfile: Dockerfile.tmpl

mixins:
  - exec
  - kubernetes
  - az


parameters:
  - name: AZURE_RESOURCE_GROUP_UPSERT
    description: "The azure resource group to use or create for the cluster resources."
    default: winlin
  - name: CLUSTER_DEPLOYMENT_REGION
    description: "The azure resource group to use or create for the cluster resources."
    default: eastus2
  - name: CLUSTER_DEPLOYMENT_REGION
    description: "The azure resource group to use or create for the cluster resources."
    default: eastus2

install:
  - exec:
      description: "Creating the AKS cluster....."
      command: bash
      flags:
        c: echo az group create -n "{{bundle.parameters.AZURE_RESOURCE_GROUP_UPSERT}}" -l "{{bundle.parameters.CLUSTER_DEPLOYMENT_REGION}}"
  - exec:
      description: "Creating the AKS cluster....."
      command: bash
      flags:
        c: echo az aks create -n "{{bundle.parameters.AZURE_RESOURCE_GROUP_UPSERT}}" -l "{{bundle.parameters.CLUSTER_DEPLOYMENT_REGION}}"
  - exec:
      description: "Adding the Windows nodes to the cluster..."
      command: bash
      flags:
        c: echo az aks nodepool add -g "{{bundle.parameters.AZURE_RESOURCE_GROUP_UPSERT}}" --cluster-name $CLUSTER_NAME --os-type Windows -n window -c 2 --node-vm-size Standard_D3s_v3
  - exec:
      description: "Adding the taints to the Windows nodes so Linux workloads that don't tolerate Windows nodes are scheduled elsewhere....."
      command: bash
      flags:
        c: echo $(kubectl get nodes -l beta.kubernetes.io/os=windows -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}' | xargs -I XX kubectl taint nodes XX windows=true:NoSchedule)

upgrade:
  - exec:
      description: "Not supported. Clusters are cattle, not pets, unless you're in production. And even then, they should be pets."
      command: bash
      flags:
        c: echo You can wait quite a while here if you do this.

uninstall:
  - exec:
      description: "Destroying the cluster...."
      command: bash
      flags:
        c: echo Goodbye World


# See https://porter.sh/authoring-bundles/#dependencies
#dependencies:
#  mysql:
#    tag: deislabs/porter-mysql:latest
#    parameters:
#      database-name: wordpress

# See https://porter.sh/wiring/#credentials
#credentials:
#  - name: kubeconfig
#    path: /root/.kube/config
